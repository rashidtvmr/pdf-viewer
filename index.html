<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PDF Viewer with Fallbacks</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #loader {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-size: 18px;
    }
    #viewer, #fallbackCanvas {
      width: 100%;
      height: 100vh;
      border: none;
    }
  </style>
</head>
<body>

<div id="loader">üîÑ Loading PDF...</div>
<div id="viewer" style="display: none;"></div>

<script>
  const viewer = document.getElementById('viewer');
  const loader = document.getElementById('loader');

  const params = new URLSearchParams(window.location.search);
  const file = params.get('file');

  if (!file) {
    loader.textContent = "‚ùå No PDF file provided in URL. Use ?file=your.pdf";
    throw new Error("No file param found.");
  }

  // Step 1: Check if PDF rendering in iframe is supported
  function canEmbedPDF() {
    const iframe = document.createElement('iframe');
    iframe.type = 'application/pdf';
    return !!iframe.type;
  }

  // Step 2: Try to load iframe directly
  function tryEmbedPDFDirectly(url) {
    return new Promise((resolve, reject) => {
      const iframe = document.createElement('iframe');
      iframe.id = 'native-pdf';
      iframe.src = url;
      iframe.onload = () => resolve(iframe);
      iframe.onerror = () => reject('iframe failed');
      iframe.style.border = "none";
      iframe.style.width = "100%";
      iframe.style.height = "100%";

      // Small timeout in case iframe fails silently
      setTimeout(() => {
        if (iframe.contentDocument?.body?.childElementCount === 0) {
          reject("iframe loaded but empty");
        }
      }, 2000);

      viewer.appendChild(iframe);
    });
  }

  // Step 3: Fallback to Mozilla hosted PDF.js viewer
  function tryEmbedPDFJSViewer(file) {
    return new Promise((resolve, reject) => {
      const iframe = document.createElement('iframe');
      iframe.src = `https://mozilla.github.io/pdf.js/web/viewer.html?file=${encodeURIComponent(file)}`;
      iframe.onload = () => resolve(iframe);
      iframe.onerror = () => reject('Mozilla viewer failed');
      iframe.style.border = "none";
      iframe.style.width = "100%";
      iframe.style.height = "100%";

      viewer.innerHTML = '';
      viewer.appendChild(iframe);
    });
  }

  // Step 4: Ultimate fallback ‚Üí load PDF.js from CDN and render directly
  async function loadAndRenderWithPDFJS(file) {
    viewer.innerHTML = '';
    const canvas = document.createElement('canvas');
    canvas.id = 'fallbackCanvas';
    viewer.appendChild(canvas);

    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
    document.body.appendChild(script);

    await new Promise(res => script.onload = res);

    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    try {
      const loadingTask = pdfjsLib.getDocument(file);
      const pdf = await loadingTask.promise;
      const page = await pdf.getPage(1);

      const scale = 1.5;
      const viewport = page.getViewport({ scale });

      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      const renderContext = {
        canvasContext: context,
        viewport: viewport
      };

      await page.render(renderContext).promise;
    } catch (err) {
      loader.textContent = "‚ùå Failed to load PDF even with PDF.js";
    }
  }

  // Main logic
  async function init() {
    try {
      if (canEmbedPDF()) {
        await tryEmbedPDFDirectly(file);
        loader.style.display = "none";
        viewer.style.display = "block";
        return;
      }

      throw "Direct PDF iframe not supported";
    } catch {
      try {
        await tryEmbedPDFJSViewer(file);
        loader.style.display = "none";
        viewer.style.display = "block";
        return;
      } catch {
        try {
          await loadAndRenderWithPDFJS(file);
          loader.style.display = "none";
          viewer.style.display = "block";
        } catch (err) {
          loader.textContent = "‚ùå All PDF viewing methods failed.";
        }
      }
    }
  }

  init();
</script>

</body>
</html>
